<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diamond Slots Admin Panel (Advanced)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #4a4a8f;
        }
        #loginBox, #adminPanel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 20px auto;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            cursor: pointer;
            background-color: #4a4a8f;
            color: white;
            border: none;
        }
        button:hover {
            background-color: #3a3a7f;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #e9e9e9;
        }
    </style>
</head>
<body>
    <h1>üíé Advanced Admin Control Panel</h1>

    <div id="loginBox">
        <h2>Admin Login (Supabase Auth)</h2>
        <input type="text" id="adminUser" placeholder="Admin Username">
        <input type="password" id="adminPass" placeholder="Password">
        <button onclick="loginAdmin()">Login Securely</button>
        </div>

    <div id="adminPanel" style="display:none;">
        <h2>Player Management</h2>
        <button onclick="resetDiamonds()" style="background-color: #d9534f;">‚ö†Ô∏è Reset ALL Diamonds to 0</button>
        <button onclick="loadPlayers()" style="background-color: #5bc0de;">üîÑ Refresh Player List</button>
        <div id="playerTable">
            </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script>
        // üîë 1. CONFIGURATION (REPLACE WITH YOUR KEYS/URLS)
        const SUPABASE_URL = "https://qknwaibcivwzmdwdjluq.supabase.co"; // REPLACE THIS
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrbndhaWJjaXZ3em1kd2RqbHVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3Mzk5MTUsImV4cCI6MjA3NzMxNTkxNX0.L-vGz-UnxCCwjRG2kXbp7A-n96EviJYFpgDLOhQr57Y"; // REPLACE THIS

        // üîó EDGE FUNCTION URLs (PASTE YOUR DEPLOYED URLs HERE)
        const RESET_FUNCTION_URL = "https://your-project-ref.supabase.co/functions/v1/admin-reset"; // <<< REPLACE THIS!
        const GIVE_DIAMONDS_FUNCTION_URL = "https://your-project-ref.supabase.co/functions/v1/admin-give-diamonds"; // <<< REPLACE THIS!

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const PLAYER_TABLE = "players"; 

        // --- 2. ADVANCED AUTHENTICATION (Uses Supabase Auth and RBAC Check) ---
        async function loginAdmin() {
            const username = document.getElementById("adminUser").value;
            const password = document.getElementById("adminPass").value;

            if (!username || !password) return alert("Enter both username and password.");

            let authStatus = document.getElementById("loginBox").querySelector('#statusMessage');
            if (!authStatus) {
                authStatus = document.createElement('p');
                authStatus.id = 'statusMessage';
                document.getElementById("loginBox").appendChild(authStatus);
            }
            authStatus.textContent = "Attempting secure login...";

            // --- FIX IS HERE ---
            const safeUsername = username.toLowerCase().trim().replace(/[^a-z0-9.-]/g, '-');
            const email = `${safeUsername}@game.local`;
            // -------------------

            // 1. Authenticate the user
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                authStatus.textContent = "‚ùå Login failed: " + error.message;
                return;
            }

            // 2. CHECK FOR ADMIN ROLE (RBAC) via the custom claim in the JWT
            const isAdmin = data.session.user.app_metadata.is_admin === true;

            if (isAdmin) {
                authStatus.textContent = `‚úÖ Welcome Admin: ${username}!`;
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("adminPanel").style.display = "block";
                loadPlayers();
            } else {
                // Sign out the non-admin user immediately for security
                await supabase.auth.signOut();
                authStatus.textContent = "üîí Access Denied: You are not an authorized administrator.";
            }
        }

        // --- 3. LOAD PLAYERS (SELECT is allowed by RLS) ---
        async function loadPlayers() {
            const { data, error } = await supabase
                .from(PLAYER_TABLE)
                .select("id, username, diamonds, is_admin") 
                .order("diamonds", { ascending: false });

            if (error) {
                alert("Error loading players: " + error.message);
                return;
            }

            let html = `<table>
                <tr><th>Username</th><th>Diamonds</th><th>Admin</th><th>Action</th></tr>`;

            data.forEach(player => {
                const adminStatus = player.is_admin ? '‚úÖ' : '‚ùå';
                const toggleAction = player.is_admin ? 'Revoke Admin' : 'Grant Admin';
                const toggleColor = player.is_admin ? '#f0ad4e' : '#5cb85c';

                html += `<tr>
                    <td>${player.username}</td>
                    <td>${player.diamonds}</td>
                    <td>${adminStatus}</td>
                    <td>
                        <input type="number" id="add-${player.id}" placeholder="Add amount" style="width:80px;">
                        <button onclick="giveDiamonds('${player.id}')">üíé Give</button>
                        <button onclick="toggleAdmin('${player.id}', ${!player.is_admin})" style="background-color:${toggleColor};">${toggleAction}</button>
                    </td>
                </tr>`;
            });

            html += "</table>";
            document.getElementById("playerTable").innerHTML = html;
        }

        // --- 4. SECURE FUNCTION: Toggle Admin Status ---
        async function toggleAdmin(playerId, becomeAdmin) {
            if (!confirm(`Are you sure you want to ${becomeAdmin ? 'GRANT' : 'REVOKE'} admin status for this user?`)) return;

            try {
                const { error } = await supabase
                    .from(PLAYER_TABLE)
                    .update({ is_admin: becomeAdmin })
                    .eq('id', playerId);

                if (error) {
                    alert("‚ùå Failed to change role: " + error.message + ". Check your RLS or use a dedicated Edge Function for this update.");
                } else {
                    alert(`‚úÖ Admin status ${becomeAdmin ? 'GRANTED' : 'REVOKED'}. The user must log out and back in to refresh their permissions.`);
                    loadPlayers();
                }
            } catch (e) {
                console.error(e);
            }
        }


        // --- 5. SECURE FUNCTION CALL: GIVE DIAMONDS (Calls the Edge Function) ---
        async function giveDiamonds(playerId) {
            const input = document.getElementById(`add-${playerId}`);
            const addAmount = parseInt(input.value);
            
            if (isNaN(addAmount) || addAmount === 0) return alert("Enter a valid non-zero amount!");
            
            try {
                const response = await fetch(GIVE_DIAMONDS_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: playerId, 
                        amount_to_add: addAmount
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(`‚úÖ ${addAmount} Diamonds added!`);
                    input.value = ''; 
                    loadPlayers(); 
                } else {
                    alert("‚ùå Error giving diamonds: " + (result.error || "Unknown error"));
                }
            } catch (e) {
                alert("‚ùå Network Error: Could not connect to the function.");
                console.error("Fetch Error:", e);
            }
        }

        // --- 6. SECURE FUNCTION CALL: RESET DIAMONDS (Calls the Edge Function) ---
        async function resetDiamonds() {
            if (!confirm("‚ö†Ô∏è Are you sure you want to reset ALL players' diamonds to 0? This cannot be undone.")) return;

            try {
                const response = await fetch(RESET_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert("‚úÖ All player diamonds reset to 0!");
                    loadPlayers();
                } else {
                    alert("‚ùå Error resetting: " + (result.error || "Unknown error"));
                }
            } catch (e) {
                alert("‚ùå Network Error: Could not connect to the reset function.");
                console.error("Fetch Error:", e);
            }
        }
    </script>
</body>
</html>
